<!-- PAGE3 VERSION 2025-10-10 PP-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estimation Page 3 - Alliance Marine</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
</head>
<body class="bg-light">

{% include 'navbar.html' %}

<div class="container mt-4">
  <div class="card shadow">
    <div class="card-body">
      <h3 class="text-primary mb-3">Container: <strong>{{ container.container_no }}</strong></h3>
      
      <!-- Entry form -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">Category</label>
          <select id="categorySelect" class="form-select">
            <option value="">Select Category</option>
            {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Description</label>
          <select id="descriptionSelect" class="form-select" disabled></select>
        </div>
        <div class="col-md-2" id="dimensionCol" style="display:none;">
          <label class="form-label">Dimension</label>
          <select id="dimensionSelect" class="form-select"></select>
          <input type="number" id="dimensionInput" class="form-control" style="display:none;" placeholder="Enter dimension">
        </div>
        <div class="col-md-2">
          <label class="form-label">MAT.COST</label>
          <input type="text" id="matCost" class="form-control" readonly>
        </div>
        <div class="col-md-2">
          <label class="form-label">MAN.HRS</label>
          <input type="number" id="manHrs" class="form-control" step="0.1" min="0">
        </div>
      </div>
      <button class="btn btn-primary mb-3" id="addEntryBtn">Add Entry</button>
      <button type="button" class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#manualEntryDrawer">
        <i class="bi bi-plus-circle me-1"></i> Add Manual Entry
      </button>
   
<!-- Manual Repair Entry Drawer -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="manualEntryDrawer" aria-labelledby="manualEntryLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold" id="manualEntryLabel">Add Manual Repair Entry</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="manualEntryForm">
      <div class="mb-3">
        <label class="form-label">Category</label>
        <select class="form-select" id="manualCategory">
          <option value="">Select existing category</option>
          {% for cat in categories %}
            <option value="{{ cat }}">{{ cat }}</option>
          {% endfor %}
          <option value="__new__">+ Add new category</option>
        </select>
      </div>

      <div class="mb-3 d-none" id="newCategoryBox">
        <label class="form-label">New Category Name</label>
        <input type="text" id="newCategoryName" class="form-control" placeholder="Enter new category name">
      </div>

      <div class="mb-3">
        <label class="form-label">Description</label>
        <input type="text" id="manualDescription" class="form-control" placeholder="Enter repair description" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Dimension (optional)</label>
        <input type="text" id="manualDimension" class="form-control" placeholder="e.g., 2x4">
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">MAT COST</label>
          <input type="number" id="manualMatCost" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">MAN HRS</label>
          <input type="number" step="0.1" id="manualManHrs" class="form-control" required>
        </div>
      </div>

      <div class="text-end">
        <button type="button" class="btn btn-primary" id="saveManualEntryBtn">
          <i class="bi bi-save me-1"></i> Save Entry
        </button>
      </div>
    </form>
  </div>
</div>


      <!-- Entries table -->
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle" id="entriesTable">
          <thead class="table-light">
            <tr>
              <th>Category</th>
              <th>Description</th>
              <th>Dimension</th>
              <th>MAT.COST</th>
              <th>MAN.HRS</th>
              <th>LAB.COST</th>
              <th>TOTAL</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot class="table-light">
          <tr>
            <th colspan="3" class="text-end">Totals:</th>
            <th id="totalMat">0.00</th>
            <th></th>
            <th id="totalLab">0.00</th>
            <th id="grandTotal">0.00</th>
            <th></th>
          </tr>
        </tfoot>
        </table>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <a href="{{ url_for('estimation') }}" class="btn btn-secondary">Back</a>
        <div>
          <button class="btn btn-success" id="exportExcel">Export Excel</button>
          <button class="btn btn-danger" id="exportPDF">Export PDF</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastContainer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<div id="containerData" data-container='{{ container|tojson | safe }}'></div>

<script>
  const containerEl = document.getElementById("containerData");
  let windowContainerObj = {};
  try {
    windowContainerObj = JSON.parse(containerEl.getAttribute("data-container"));
  } catch (e) {
    console.error("Failed to parse container data", e);
    windowContainerObj = {};
  }
  window.containerObj = windowContainerObj;
  console.log("ContainerObj loaded:", window.containerObj);
  let entries = [];

  function showToast(msg, type="danger") {
    const toastId = "toast-" + Date.now();
    const html = `
      <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    document.getElementById("toastContainer").insertAdjacentHTML("beforeend", html);
    new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 }).show();
  }

  // === Category & Description loading ===
  const categorySelect = document.getElementById("categorySelect");
  const descriptionSelect = document.getElementById("descriptionSelect");
  const dimensionCol = document.getElementById("dimensionCol");
  const dimensionSelect = document.getElementById("dimensionSelect");
  const dimensionInput = document.getElementById("dimensionInput");
  const matCostInput = document.getElementById("matCost");
  const manHrsInput = document.getElementById("manHrs");

  categorySelect.addEventListener("change", async () => {
    const category = categorySelect.value;
    descriptionSelect.innerHTML = "";
    matCostInput.value = "";
    if (!category) {
      descriptionSelect.disabled = true;
      return;
    }
    const res = await fetch(`/api/descriptions?category=${encodeURIComponent(category)}`);
    const data = await res.json();
    descriptionSelect.disabled = false;
    descriptionSelect.innerHTML = `<option value="">Select Description</option>`;
    data.forEach(item => {
      descriptionSelect.innerHTML += `<option value="${item.description}" data-dims='${JSON.stringify(item.dimensions)}' data-hasdims="${item.has_dimensions}">${item.description}</option>`;
    });
  });

  descriptionSelect.addEventListener("change", async () => {
    const desc = descriptionSelect.value;
    const category = categorySelect.value;
    matCostInput.value = "";
    dimensionCol.style.display = "none";
    dimensionInput.style.display = "none";
    dimensionSelect.style.display = "none";

// ✅ Always reset dimension fields when changing description
    dimensionSelect.innerHTML = "";
    dimensionInput.value = "";

    if (!desc) return;

    const selected = descriptionSelect.options[descriptionSelect.selectedIndex];
    const hasDims = selected.getAttribute("data-hasdims") === "true";
    const dims = JSON.parse(selected.getAttribute("data-dims"));

// ✅ Handle "EVERY ADDITIONAL" separately
    if (desc.startsWith("EVERY ADDITIONAL")) {
      dimensionCol.style.display = "block";
      dimensionInput.style.display = "block";
      dimensionSelect.style.display = "none";
    }
// ✅ Handle descriptions that have specific dimension options
    else if (hasDims && dims && dims.length > 0) {
      dimensionCol.style.display = "block";
      dimensionSelect.style.display = "block";
      dimensionInput.style.display = "none";
      dimensionSelect.innerHTML = `<option value="">Select Dimension</option>`;
      dims.forEach(d => {
        dimensionSelect.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }
// ✅ Descriptions without dimensions — hide and clear field
    else {
      dimensionCol.style.display = "none";
      dimensionInput.value = "";
      dimensionSelect.innerHTML = "";
    }

    const res = await fetch(`/api/matcost?category=${encodeURIComponent(category)}&description=${encodeURIComponent(desc)}`);
    const data = await res.json();
    matCostInput.value = data.mat_cost;
  });

  dimensionSelect.addEventListener("change", async () => {
    const category = categorySelect.value;
    const desc = descriptionSelect.value;
    const dim = dimensionSelect.value;
    const res = await fetch(`/api/matcost?category=${encodeURIComponent(category)}&description=${encodeURIComponent(desc)}&dimension=${encodeURIComponent(dim)}`);
    const data = await res.json();
    matCostInput.value = data.mat_cost;
  });

  dimensionInput.addEventListener("input", async () => {
    const category = categorySelect.value;
    const desc = descriptionSelect.value;
    const dim = dimensionInput.value;
    if (!dim) return;
    const res = await fetch(`/api/matcost?category=${encodeURIComponent(category)}&description=${encodeURIComponent(desc)}&dimension=${encodeURIComponent(dim)}`);
    const data = await res.json();
    matCostInput.value = data.mat_cost;
  });

  // === Add entry ===
  document.getElementById("addEntryBtn").addEventListener("click", () => {
    const category = categorySelect.value;
    const desc = descriptionSelect.value;
    const dim = dimensionInput.style.display === "block" ? dimensionInput.value : dimensionSelect.value;
    const matCost = parseFloat(matCostInput.value || 0);
    const manHrs = parseFloat(manHrsInput.value || 0);
    const labCost = manHrs * 75;
    const total = matCost + labCost;

    if (!category || !desc) {
      showToast("Select Category and Description");
      return;
    }

    window.entries.push({ category, description: desc, dimension: dim, mat_cost: matCost, man_hrs: manHrs, lab_cost: labCost, total });
    renderEntries();
  });

  function renderEntries() {
  console.log("renderEntries() called with entries:", window.entries);

  const tbody = document.querySelector("#entriesTable tbody");
  if (!tbody) {
    console.warn("No table body found for #entriesTable!");
    return;
  }

  tbody.innerHTML = "";
  let totalMat = 0, totalLab = 0, totalAll = 0;

  // ✅ Use the correct global variable reference
  const data = window.entries || [];

  if (data.length === 0) {
    console.log("No entries to render yet.");
    return;
  }

  data.forEach((e, i) => {
    totalMat += e.mat_cost;
    totalLab += e.lab_cost;
    totalAll += e.total;

    const row = `
      <tr>
        <td>${e.category}</td>
        <td>${e.description}</td>
        <td>${e.dimension || ""}</td>
        <td>${e.mat_cost.toFixed(2)}</td>
        <td>${e.man_hrs}</td>
        <td>${e.lab_cost.toFixed(2)}</td>
        <td>${e.total.toFixed(2)}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})">Delete</button></td>
      </tr>`;

    // ✅ Corrected insertion method ("beforeend" was misspelled in your code)
    tbody.insertAdjacentHTML("beforeend", row);
  });

  console.log(`Rendered ${data.length} entries to table.`);

  // ✅ Update total labels (if these exist)
  const totalMatEl = document.getElementById("totalMat");
  const totalLabEl = document.getElementById("totalLab");
  const grandTotalEl = document.getElementById("grandTotal");

  if (totalMatEl) totalMatEl.innerText = totalMat.toFixed(2);
  if (totalLabEl) totalLabEl.innerText = totalLab.toFixed(2);
  if (grandTotalEl) grandTotalEl.innerText = totalAll.toFixed(2);
}

  function deleteEntry(i) {
    window.entries.splice(i, 1);
    renderEntries();
  }

  // === Export helpers ===
  function filenameFromContentDisposition(cd, fallback) {
    if (!cd) return fallback;
    let m = cd.match(/filename\*?=['"]?UTF-8''([^;\r\n"]+)/) || cd.match(/filename="?([^;"]+)"?/);
    if (!m) return fallback;
    try { return decodeURIComponent(m[1].replace(/\+/g, '%20')); }
    catch (e) { return m[1].replace(/"/g, ''); }
  }

  async function downloadResponseAsFile(resp, fallbackName) {
    if (!resp.ok) {
      const t = await resp.text();
      showToast("Export failed: " + (t || resp.statusText));
      return;
    }
    const blob = await resp.blob();
    const cd = resp.headers.get('Content-Disposition') || '';
    const filename = filenameFromContentDisposition(cd, fallbackName);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("exportExcel").addEventListener("click", async () => {
  if (!window.entries || window.entries.length === 0)
    return showToast("Add at least one entry before exporting");

  const payload = {
    entries: window.entries,
    container: window.containerObj
  };

  try {
    const resp = await fetch("/export_excel", {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const fallback = window.containerObj?.container_no
      ? `${window.containerObj.container_no}.xlsx`
      : "estimation.xlsx";
    await downloadResponseAsFile(resp, fallback);
  } catch (err) {
    console.error(err);
    showToast("Excel export failed.", "danger");
  }
});

  document.getElementById("exportPDF").addEventListener("click", async () => {
  if (!window.entries || window.entries.length === 0)
    return showToast("Add at least one entry before exporting");

  const payload = {
    entries: window.entries,
    container: window.containerObj
  };

  try {
    const resp = await fetch("/export_pdf", {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const fallback = window.containerObj?.container_no
      ? `${window.containerObj.container_no}.pdf`
      : "estimation.pdf";
    await downloadResponseAsFile(resp, fallback);
  } catch (err) {
    console.error(err);
    showToast("PDF export failed.", "danger");
  }
});

 document.addEventListener("DOMContentLoaded", () => {
  window.entries = window.entries || [];

  const manualCategory = document.getElementById("manualCategory");
  const newCategoryBox = document.getElementById("newCategoryBox");
  const newCategoryName = document.getElementById("newCategoryName");
  const manualDescription = document.getElementById("manualDescription");
  const manualDimension = document.getElementById("manualDimension");
  const manualMatCost = document.getElementById("manualMatCost");
  const manualManHrs = document.getElementById("manualManHrs");
  const saveBtn = document.getElementById("saveManualEntryBtn");
  const form = document.getElementById("manualEntryForm");
  const drawerEl = document.getElementById("manualEntryDrawer");

  manualCategory.addEventListener("change", (e) => {
    if (e.target.value === "__new__") {
      newCategoryBox.classList.remove("d-none");
      newCategoryName.focus();
    } else {
      newCategoryBox.classList.add("d-none");
    }
  });

  saveBtn.addEventListener("click", async () => {
    let category = manualCategory.value;
    if (category === "__new__") {
      category = newCategoryName.value.trim();
      if (!category) {
        showToast("Please enter new category name.", "danger");
        return;
      }
    }

    const description = manualDescription.value.trim();
    const dimension = manualDimension.value.trim() || "";
    const matCost = parseFloat(manualMatCost.value) || 0;
    const manHrs = parseFloat(manualManHrs.value) || 0;

    if (!category || !description) {
      showToast("Please enter both category and description.", "danger");
      return;
    }

    const labCost = manHrs * 75;
    const total = matCost + labCost;

    // Add entry to array
    window.entries.push({
      category,
      description,
      dimension,
      mat_cost: matCost,
      man_hrs: manHrs,
      lab_cost: labCost,
      total
    });

    console.log("entries before render:", window.entries);

    // Render table (safe call)
    if (typeof renderEntries === "function") {
      renderEntries();
    } else {
      setTimeout(() => renderEntries && renderEntries(), 500);
    }

    // Save to DB
  try {
    const res = await fetch("/add_manual_tariff", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category, description, dimension, mat_cost: matCost }),
    });

    const data = await res.json();

    if (res.ok) {
      showToast(data.message || "Saved to tariffs", "success");

    // 🟢 NEW: Update dropdowns instantly without page refresh
      const newTariff = {
        category,
        description,
        dimension: dimension || "",
      };

    // ✅ Update Category dropdown if not already there
      const categorySelect = document.getElementById("categorySelect");
      const existingCat = Array.from(categorySelect.options).some(
        (opt) => opt.value === newTariff.category
      );

      if (!existingCat) {
        const opt = document.createElement("option");
        opt.value = newTariff.category;
        opt.textContent = newTariff.category;
        categorySelect.appendChild(opt);
      }

    // ✅ If current category is selected, update Description dropdown
      if (categorySelect.value === newTariff.category) {
        const descSelect = document.getElementById("descriptionSelect");
        const existingDesc = Array.from(descSelect.options).some(
          (opt) => opt.value === newTariff.description
        );
      if (!existingDesc) {
        const opt = document.createElement("option");
        opt.value = newTariff.description;
        opt.textContent = newTariff.description;
        descSelect.appendChild(opt);
      }
    }

    // ✅ Optionally, reset form inputs for clarity
    document.getElementById("manualCategory").value = "";
    document.getElementById("manualDescription").value = "";
    document.getElementById("manualMatCost").value = "";

  } else {
    showToast(data.error || "Failed to save", "danger");
  }
} catch (err) {
  console.error(err);
  showToast("Network error", "danger");
}

    // Reset and close drawer
    const drawer = bootstrap.Offcanvas.getInstance(drawerEl);
    drawer?.hide();
    form.reset();
    newCategoryBox.classList.add("d-none");
  });
});

</script>
</body>
</html>
