<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports - Alliance Marine</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #searchInput { max-width: 250px; }
  </style>
</head>
<body class="bg-light">

{% include 'navbar.html' %}

<div class="container mt-5">
  <div class="card shadow-lg">
    <div class="card-body">
      <h3 class="text-primary text-center mb-4">Your Reports</h3>
      <p class="text-center">Total reports generated: <strong>{{ total_reports }}</strong></p>

      <!-- Toolbar: search + filters + export -->
      <div class="d-flex flex-column flex-md-row flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <!-- Search -->
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search reports..." style="max-width: 250px;">

        <!-- Filters -->
        <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
          <input type="date" id="fromDate" class="form-control">
          <input type="date" id="toDate" class="form-control">

          <!-- File type filter -->
          <select id="fileTypeFilter" class="form-select">
            <option value="">All Types</option>
            <option value="pdf">PDF</option>
            <option value="excel">Excel</option>
          </select>

          <!-- Line filter -->
          <select id="lineFilter" class="form-select">
            <option value="">All Lines</option>
            {% for line in lines %}
              <option value="{{ line }}">{{ line }}</option>
            {% endfor %}
          </select>

          {% if is_admin %}
            <select id="userFilter" class="form-select">
              <option value="">All Users</option>
              {% for u in users %}
                <option value="{{ u }}">{{ u }}</option>
              {% endfor %}
            </select>
          {% endif %}

          <button class="btn btn-outline-primary" id="filterBtn">Filter</button>
          <button class="btn btn-outline-secondary" id="resetFiltersBtn">Reset</button>
        </div>

        <!-- Export reports list -->
        <a href="{{ url_for('export_reports_excel') }}" class="btn btn-outline-success">
          {% if is_admin %}Export All Reports{% else %}Export My Reports{% endif %}
        </a>
        <button class="btn btn-outline-success" id="exportReportsBtn">Export Excel</button>
      </div>

      {% if reports %}
      <div class="table-responsive">
        <table id="reportsTable" class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Container No</th>
              <th>Line</th>
              {% if is_admin %}
               <th>User</th>
              {% endif %}
              <th>File Type</th>
              <th>Date</th>
              <th>Preview</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reports %}
            <tr data-id="{{ r.id }}" 
                data-line="{{ r.line }}" 
                data-filetype="{{ r.file_type }}" 
                data-date="{{ r.timestamp.strftime('%Y-%m-%d') }}" 
                data-user="{{ r.username }}">
              <td>{{ loop.index }}</td>
              <td><strong>{{ r.container_no }}</strong></td>
              <td>{{ r.line }}</td>
              {% if is_admin %}
                <td>{{ r.username }}</td>
              {% endif %}
              <td>
                {% if r.file_type == "pdf" %}
                  <span class="badge bg-danger">PDF</span>
                {% else %}
                  <span class="badge bg-success">Excel</span>
                {% endif %}
              </td>
              <td data-date="{{ r.timestamp.strftime('%Y-%m-%d') }}">
                  {{ r.timestamp.strftime("%Y-%m-%d %H:%M") }}
              </td>
              <td>
                <a href="{{ url_for('preview_report', report_id=r.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  Preview
                </a>
              </td>
              <td>
                <button class="btn btn-sm btn-danger delete-btn" data-id="{{ r.id }}">
                   Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-center text-muted">No reports generated yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
function filterReports() {
  const searchFilter = document.getElementById("searchInput").value.toLowerCase(); // container_no
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;
  const fileTypeFilter = document.getElementById("fileTypeFilter").value;
  const lineFilter = document.getElementById("lineFilter")?.value || "";
  const userFilter = document.getElementById("userFilter") ? document.getElementById("userFilter").value : "";

  const rows = document.querySelectorAll("#reportsTable tbody tr");

  rows.forEach(row => {
    const rowText = row.innerText.toLowerCase();
    const dateAttr = row.getAttribute("data-date");
    const rowFileType = row.getAttribute("data-filetype")?.toLowerCase() || "";
    const rowLine = row.getAttribute("data-line")?.toLowerCase() || "";
    const rowUser = row.getAttribute("data-user")?.toLowerCase() || "";

    let show = true;

    // Container number search
    if (searchFilter && !rowText.includes(searchFilter)) show = false;

    // Line dropdown filter
    if (lineFilter && rowLine !== lineFilter.toLowerCase()) show = false;

    // File type filter
    if (fileTypeFilter && rowFileType !== fileTypeFilter.toLowerCase()) show = false;

    // Date range filter
    if (fromDate && toDate && dateAttr) {
      const rowDate = new Date(dateAttr);
      const from = new Date(fromDate);
      const to = new Date(toDate);
      if (rowDate < from || rowDate > to) show = false;
    }

    // Admin user filter
    if (userFilter && rowUser !== userFilter.toLowerCase()) show = false;

    row.style.display = show ? "" : "none";
  });
}

// Attach events
document.getElementById("searchInput").addEventListener("keyup", filterReports);
document.getElementById("filterBtn").addEventListener("click", filterReports);
document.getElementById("fileTypeFilter").addEventListener("change", filterReports);
if (document.getElementById("lineFilter")) document.getElementById("lineFilter").addEventListener("change", filterReports);
if (document.getElementById("userFilter")) document.getElementById("userFilter").addEventListener("change", filterReports);

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const reportId = btn.dataset.id;
      if (!confirm("Are you sure you want to delete this report?")) return;

      try {
        const res = await fetch(`/delete_report/${reportId}`, { method: "POST" });
        const data = await res.json();
        if (res.ok) {
          alert(data.message || "Report deleted successfully");
          location.reload();
        } else {
          alert(data.error || "Failed to delete report");
        }
      } catch (err) {
        console.error(err);
        alert("Error deleting report");
      }
    });
  });
});

document.getElementById("exportReportsBtn").addEventListener("click", async () => {
  // Get all visible rows
  const visibleRows = Array.from(document.querySelectorAll("#reportsTable tbody tr"))
    .filter(row => row.style.display !== "none");

  if (visibleRows.length === 0) {
    alert("No reports match the current filters!");
    return;
  }

  const reportIds = visibleRows.map(row => row.dataset.id);

  try {
    const response = await fetch("/export_filtered_reports_excel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ report_ids: reportIds })
    });

    if (!response.ok) throw new Error("Failed to export filtered reports.");

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "filtered_reports.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  } catch (err) {
    console.error(err);
    alert("Error exporting filtered reports.");
  }
});

document.getElementById("resetFiltersBtn").addEventListener("click", () => {
  // Clear all filter inputs
  const inputs = ["searchInput", "fromDate", "toDate", "fileTypeFilter", "lineFilter", "userFilter"];
  inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // Show all rows again
  const rows = document.querySelectorAll("#reportsTable tbody tr");
  rows.forEach(row => {
    row.style.display = "";
  });

  // Optional: Flash feedback
  const btn = document.getElementById("resetFiltersBtn");
  btn.disabled = true;
  btn.textContent = "Reset âœ“";
  setTimeout(() => {
    btn.disabled = false;
    btn.textContent = "Reset";
  }, 1000);
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
